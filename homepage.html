<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blood Link | Fresh UI</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --app-font-family: 'Poppins', sans-serif;

            /* Light Theme */
            --app-primary-color: #007AFF; /* Action Blue */
            --app-primary-hover: #0056b3;
            --app-accent-color: #FF3B30;  /* Urgent Red */
            --app-accent-hover: #D92C2E;
            --app-success-color: #34C759; /* Green */
            
            --app-text-primary: #1c1c1e;
            --app-text-secondary: #636366;
            --app-text-on-primary: #ffffff;
            --app-text-on-accent: #ffffff;

            --app-bg-main: #f2f2f7;         /* Overall page background */
            --app-bg-content: #ffffff;      /* Card, modal, sidebar backgrounds */
            --app-bg-input: #ffffff;

            --app-border-color: #d1d1d6;
            --app-border-input: #c6c6c8;
            --app-shadow: rgba(0, 0, 0, 0.08);

            --app-sidebar-width: 250px;
            --app-mobile-header-height: 55px;
            
            /* RGB values for box-shadows with alpha */
            --app-primary-color-rgb: 0, 122, 255;
            --app-accent-color-rgb: 255, 59, 48;
        }

        body.dark {
            --app-primary-color: #0A84FF;
            --app-primary-hover: #0060df;
            --app-accent-color: #FF453A;
            --app-accent-hover: #E0202A;
            --app-success-color: #30D158;

            --app-text-primary: #ffffff;
            --app-text-secondary: #aeaeb2;
            /* --app-text-on-primary: #ffffff; */ /* Stays same */
            /* --app-text-on-accent: #ffffff; */ /* Stays same */

            --app-bg-main: #000000;
            --app-bg-content: #1c1c1e;
            --app-bg-input: #2c2c2e;

            --app-border-color: #3a3a3c;
            --app-border-input: #48484a;
            --app-shadow: rgba(0, 0, 0, 0.25);
        }

        /* --- Base & Reset --- */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--app-font-family);
            margin: 0;
            background-color: var(--app-bg-main);
            color: var(--app-text-primary);
            line-height: 1.6;
            font-size: 15px;
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex; /* For app-shell structure */
        }

        /* --- App Shell --- */
        .app-shell {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        .app-sidebar {
            width: var(--app-sidebar-width);
            background-color: var(--app-bg-content);
            border-right: 1px solid var(--app-border-color);
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 1000;
            transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
        }
        .app-sidebar .logo-section {
            display: flex;
            align-items: center;
            padding: 0 10px 20px 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--app-border-color);
        }
        .app-sidebar .logo-image { height: 40px; margin-right: 12px; border-radius: 4px;}
        .app-sidebar .app-name { font-size: 20px; font-weight: 600; color: var(--app-text-primary); margin: 0;}

        .app-sidebar nav { flex-grow: 1; }
        .app-sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .app-sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 6px;
            text-decoration: none;
            color: var(--app-text-secondary);
            font-weight: 500;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .app-sidebar nav ul li a .nav-icon { margin-right: 12px; width: 20px; text-align: center; /* Placeholder for icon */}
        .app-sidebar nav ul li a:hover { background-color: var(--app-bg-main); color: var(--app-primary-color); }
        .app-sidebar nav ul li a.active-link { background-color: var(--app-primary-color); color: var(--app-text-on-primary); }
        .app-sidebar nav ul li a.active-link:hover { background-color: var(--app-primary-hover); }
        .app-sidebar nav ul li a.emergency-link { /* color: var(--app-accent-color); */ } /* Optional: Make emergency links stand out */
        .app-sidebar nav ul li a.emergency-link.active-link { background-color: var(--app-accent-color); color: var(--app-text-on-accent); }
        .app-sidebar nav ul li a.emergency-link.active-link:hover { background-color: var(--app-accent-hover); }

        .sidebar-footer { margin-top: auto; padding: 15px 10px 0 10px; border-top: 1px solid var(--app-border-color); }
        .dark-mode-toggle { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .dark-mode-toggle label { font-size: 13px; color: var(--app-text-secondary); }
        /* Re-using previous toggle switch style, slightly adapted */
        .toggle-switch { position: relative; display: inline-block; width: 42px; height: 22px; border-radius: 22px; background-color: var(--app-border-input); cursor: pointer; transition: background-color .3s ease; border: 1px solid transparent; }
        body.dark .toggle-switch { background-color: var(--app-border-input); }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; top: 1px; left: 1px; width: 18px; height: 18px; background-color: var(--app-bg-content); border-radius: 50%; transition: transform .3s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,.2); }
        body.dark .toggle-slider { background-color: var(--app-bg-main); }
        .toggle-switch input:checked + .toggle-slider { transform: translateX(20px); background-color: var(--app-primary-color); } /* Keep slider color for checked state */
        body.dark .toggle-switch input:checked + .toggle-slider { background-color: var(--app-primary-color); }

        .sidebar-app-mode { font-size: 11px; text-align: center; color: var(--app-text-secondary); opacity: 0.7; }

        /* --- Main Content Area --- */
        .main-view {
            flex-grow: 1;
            margin-left: var(--app-sidebar-width); /* Space for sidebar */
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease-in-out;
        }
        .mobile-header {
            display: none; /* Hidden on desktop */
            height: var(--app-mobile-header-height);
            background-color: var(--app-bg-content);
            border-bottom: 1px solid var(--app-border-color);
            align-items: center;
            padding: 0 15px;
            position: sticky; /* Or fixed if you want it always visible */
            top: 0;
            z-index: 900;
        }
        .mobile-header .menu-toggle { background: none; border: none; font-size: 24px; color: var(--app-text-primary); cursor: pointer; padding: 5px; }
        .mobile-header .mobile-app-name { font-size: 18px; font-weight: 600; color: var(--app-text-primary); margin-left: 10px; }

        .content- Mcontainer {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto; /* Allows content to scroll independently */
        }
        section { display: none; animation: fadeIn 0.4s ease-out; }
        section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--app-border-color);
        }
        .page-header h1 { font-size: 26px; font-weight: 600; color: var(--app-text-primary); margin: 0; }

        /* --- Common Components --- */
        .content-card {
            background-color: var(--app-bg-content);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--app-shadow);
            padding: 20px 25px; /* Adjusted padding */
            margin-bottom: 25px;
        }
        .form-title {
            font-size: 22px; color: var(--app-text-primary); font-weight: 600;
            margin-bottom: 25px; padding-bottom: 10px; border-bottom: 1px solid var(--app-border-color);
        }
        
        form { display: flex; flex-direction: column; gap: 20px; }
        form div { display: flex; flex-direction: column; }
        form label {
            font-weight: 500; font-size: 13px; color: var(--app-text-secondary);
            margin-bottom: 6px; display: block;
        }
        input[type="text"], input[type="email"], input[type="tel"], select, textarea {
            background-color: var(--app-bg-input);
            border: 1px solid var(--app-border-input);
            border-radius: 6px; padding: 10px 12px; font-size: 14px;
            color: var(--app-text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }
        input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--app-primary-color);
            box-shadow: 0 0 0 3px rgba(var(--app-primary-color-rgb), 0.2);
        }
        textarea { min-height: 90px; resize: vertical; }
        form button[type="submit"], .btn {
            padding: 10px 18px; font-size: 14px; font-weight: 500;
            border-radius: 6px; border: none; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            text-align: center;
        }
        .btn-primary { background-color: var(--app-primary-color); color: var(--app-text-on-primary); }
        .btn-primary:hover { background-color: var(--app-primary-hover); transform: translateY(-1px); }
        .btn-accent { background-color: var(--app-accent-color); color: var(--app-text-on-accent); }
        .btn-accent:hover { background-color: var(--app-accent-hover); transform: translateY(-1px); }
        .btn-secondary { background-color: var(--app-bg-main); color: var(--app-text-primary); border: 1px solid var(--app-border-input); }
        .btn-secondary:hover { background-color: var(--app-border-color); } /* Slight darkening */


        /* Find Donors Table */
        .search-bar-donors { margin-bottom: 20px; }
        .search-bar-donors input { max-width: 400px; }
        .table-responsive-wrapper { overflow-x: auto; background-color: var(--app-bg-content); border-radius: 8px; box-shadow: 0 1px 4px var(--app-shadow); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td {
            padding: 12px 15px; text-align: left;
            border-bottom: 1px solid var(--app-border-color);
            font-size: 13px; vertical-align: middle;
        }
        .data-table th {
            background-color: var(--app-bg-main); font-weight: 600;
            color: var(--app-text-secondary); text-transform: uppercase; font-size: 11px;
        }
        .data-table tbody tr:hover { background-color: var(--app-bg-main); }
        .data-table .donor-id-small { display: block; font-size: 0.8em; color: var(--app-text-secondary); margin-top: 2px;}
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px;}
        .status-available { background-color: var(--app-success-color); }
        .status-unavailable { background-color: var(--app-accent-color); opacity: 0.6;}

        /* Emergency Request Cards (Fresh Style) */
        .emergency-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .emergency-card {
            background-color: var(--app-bg-content); border-radius: 8px;
            box-shadow: 0 2px 8px var(--app-shadow); padding: 18px;
            border-left: 5px solid var(--app-accent-color); /* Urgent indicator */
        }
        .emergency-card.new-urgent-pulse { animation: pulse-border-accent 1.5s infinite alternate; }
        @keyframes pulse-border-accent { 0% { border-left-color: var(--app-accent-color); } 100% { border-left-color: var(--app-primary-color); box-shadow: 0 0 10px rgba(var(--app-accent-color-rgb), 0.4); } }
        .emergency-card h3 { font-size: 17px; font-weight: 600; color: var(--app-accent-color); margin: 0 0 8px 0;}
        .emergency-card p { font-size: 13px; margin-bottom: 6px; color: var(--app-text-secondary); }
        .emergency-card p strong { color: var(--app-text-primary); font-weight: 500; }
        .emergency-card .timestamp { font-size: 0.75em; opacity: 0.7; margin-top: 10px; }
        .emergency-card .actions { margin-top: 15px; display: flex; gap: 10px; }

        /* No Data Messages */
        .no-data-message {
            text-align: center; padding: 40px 20px; background-color: var(--app-bg-content);
            border-radius: 8px; color: var(--app-text-secondary); font-size: 1.1em;
        }

        /* --- Global Messages & Loader --- */
        .global-message-toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 2000; width: 320px;
        }
        .toast-message {
            padding: 12px 18px; border-radius: 6px; font-size: 14px;
            margin-bottom: 10px; color: var(--app-text-on-primary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            display: flex; align-items: center;
        }
        .toast-message.success { background-color: var(--app-success-color); }
        .toast-message.error { background-color: var(--app-accent-color); }
        .toast-message.warning { background-color: #FF9500; /* Amber */ } /* Updated warning */

        .global-loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(var(--app-bg-main-rgb, 242, 242, 247), 0.5); /* Use RGB for alpha on bg */
            display: flex; justify-content: center; align-items: center;
            z-index: 2001; display: none; /* Initially hidden */
        }
        body.dark .global-loader-overlay { background-color: rgba(var(--app-bg-main-dark-rgb, 0,0,0), 0.6); }
        .loader-spinner {
            border: 4px solid var(--app-border-color);
            border-top: 4px solid var(--app-primary-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* Modals */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1500;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-dialog {
            background-color: var(--app-bg-content); border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            width: 90%; max-width: 500px; padding: 25px;
            transform: scale(0.95); transition: transform 0.3s ease;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-backdrop.active .modal-dialog { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--app-border-color); }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--app-text-primary); margin: 0; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--app-text-secondary); cursor: pointer; padding: 0; line-height: 1;}
        .modal-body p { font-size: 14px; margin-bottom: 8px; color: var(--app-text-secondary); }
        .modal-body p strong { color: var(--app-text-primary); }
        .modal-body .offer-item { border-bottom: 1px solid var(--app-border-color); padding-bottom: 10px; margin-bottom: 10px; }
        .modal-body .offer-item:last-child { border-bottom: none; margin-bottom: 0; }
        .modal-body .modal-reminder { font-size: 0.8em; font-style: italic; margin-top: 15px; }


        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            .app-sidebar { transform: translateX(calc(-1 * var(--app-sidebar-width))); }
            .app-sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .main-view { margin-left: 0; }
            .mobile-header { display: flex; }
            .content-container { padding: 15px; }
            .page-header h1 { font-size: 22px; }
            .page-header .btn { font-size: 13px; padding: 8px 12px;}

            .global-loader-overlay .loader-spinner { /* No offset needed if sidebar is hidden */ }
            .global-message-toast-container { width: calc(100% - 30px); right: 15px; top: 15px;}
        }

    </style>
</head>
<body>

<div class="app-shell">
    <aside class="app-sidebar" id="appSidebar">
        <div class="logo-section">
            <img src="logo.jpg" alt="Blood Link Logo" class="logo-image">
            <span class="app-name">Blood Link</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" id="nav-find" class="active-link"><span class="nav-icon">üîç</span> Find Donors</a></li>
                <li><a href="#" id="nav-register"><span class="nav-icon">‚ûï</span> Register Donor</a></li>
                <li><a href="#" id="nav-post-request" class="emergency-link"><span class="nav-icon">‚ùó</span> Post Emergency</a></li>
                <li><a href="#" id="nav-view-requests" class="emergency-link"><span class="nav-icon">üìã</span> View Emergencies</a></li>
                <li><a href="#" id="nav-about"><span class="nav-icon">‚ÑπÔ∏è</span> About</a></li>
                <li><a href="#" id="nav-admin"><span class="nav-icon">‚öôÔ∏è</span> Admin Mode</a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div class="dark-mode-toggle">
                <label for="themeToggleSwitch">Dark Mode</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="themeToggleSwitch">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="sidebar-app-mode">Mode: Client-Side</div>
        </div>
    </aside>

    <div class="main-view">
        <header class="mobile-header">
            <button class="menu-toggle" id="menuToggleBtn" aria-label="Open menu">&#9776;</button> <span class="mobile-app-name">Blood Link</span>
        </header>

        <main class="content-container">
            <section id="findDonorSection" class="active">
                <div class="page-header">
                    <h1>Find Blood Donors</h1>
                    <button class="btn btn-primary" id="actionToAddDonor">Register as Donor</button>
                </div>
                <div class="search-bar-donors">
                    <input type="text" id="donorSearchInput" placeholder="Search by name, blood group, city, ID..." class="content-card" style="padding:12px 15px; width:100%;">
                </div>
                <div class="table-responsive-wrapper" id="donorsTableContainer" style="display:none;">
                    <table class="data-table" id="donorsDisplayTable">
                        <thead>
                            <tr>
                                <th>Name / ID</th>
                                <th>Status</th>
                                <th>Blood Group</th>
                                <th>Location</th>
                                <th>Registered</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="donorsDisplayTableBody"></tbody>
                    </table>
                </div>
                <div id="donorsFallbackMessage" class="no-data-message">Loading donors...</div>
            </section>

            <section id="registerDonorSection">
                <div class="page-header"><h1>Register as a Donor</h1></div>
                <div class="content-card">
                    <h2 class="form-title">Your Details</h2>
                    <form id="donorRegistrationForm">
                        <div><label for="regName">Full Name <span style="color:var(--app-accent-color)">*</span></label><input type="text" id="regName" required></div>
                        <div><label for="regBloodGroup">Blood Group <span style="color:var(--app-accent-color)">*</span></label><select id="regBloodGroup" required><option value="">Select...</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option><option value="O+">O+</option><option value="O-">O-</option></select></div>
                        <div><label for="regPhone">Phone <span style="color:var(--app-accent-color)">*</span></label><input type="tel" id="regPhone" required></div>
                        <div><label for="regEmail">Email</label><input type="email" id="regEmail"></div>
                        <div><label for="regCity">City <span style="color:var(--app-accent-color)">*</span></label><input type="text" id="regCity" required></div>
                        <div><label for="regState">State <span style="color:var(--app-accent-color)">*</span></label><input type="text" id="regState" required></div>
                        <div><label for="regAvailability">Available to Donate?</label><select id="regAvailability"><option value="true">Yes</option><option value="false">No</option></select></div>
                        <button type="submit" class="btn btn-primary">Register My Details</button>
                    </form>
                </div>
            </section>

            <section id="postEmergencyRequestSection">
                <div class="page-header"><h1>Post Emergency Request</h1></div>
                <div class="content-card">
                    <h2 class="form-title">Emergency Details</h2>
                    <form id="emergencyPostForm">
                        <div><label for="emReqName">Requester Name <span style="color:var(--app-accent-color)">*</span></label><input type="text" id="emReqName" required></div>
                        <div><label for="emReqContact">Contact Phone <span style="color:var(--app-accent-color)">*</span></label><input type="tel" id="emReqContact" required></div>
                        <div><label for="emReqEmail">Contact Email</label><input type="email" id="emReqEmail"></div>
                        <div><label for="emReqBloodGroup">Blood Group Needed <span style="color:var(--app-accent-color)">*</span></label><select id="emReqBloodGroup" required><option value="">Select...</option><option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option><option value="B-">B-</option><option value="AB+">AB+</option><option value="AB-">AB-</option><option value="O+">O+</option><option value="O-">O-</option><option value="Any">Any</option></select></div>
                        <div><label for="emReqCity">City <span style="color:var(--app-accent-color)">*</span></label><input type="text" id="emReqCity" required></div>
                        <div><label for="emReqHospital">Hospital <span style="color:var(--app-accent-color)">*</span></label><input type="text" id="emReqHospital" required></div>
                        <div><label for="emReqMessage">Message/Urgency</label><textarea id="emReqMessage"></textarea></div>
                        <button type="submit" class="btn btn-accent">Submit Urgent Request</button>
                    </form>
                </div>
            </section>

            <section id="viewEmergencyRequestsSection">
                <div class="page-header"><h1>Active Emergency Requests</h1></div>
                <div id="emergencyRequestsGrid" class="emergency-card-grid">
                    </div>
                <div id="emergencyFallbackMessage" class="no-data-message" style="display:none;">No active emergency requests.</div>
            </section>

            <section id="aboutSection">
                <div class="page-header"><h1>About Blood Link</h1></div>
                <div class="content-card">
                    <p><strong>Blood Link</strong> is a platform dedicated to connecting voluntary blood donors with individuals in urgent need of blood. Our mission is to make the process of finding and donating blood simpler, faster, and more efficient, ultimately saving lives.</p>
                    <h3>Why Donate Blood?</h3>
                    <ul><li>A single blood donation can save up to three lives.</li><li>Blood is essential for surgeries, cancer treatment, chronic illnesses, and traumatic injuries.</li><li>There is no substitute for human blood.</li><li>Regular blood donation ensures blood is available when needed.</li></ul>
                    <h3>Our Vision</h3>
                    <p>We envision a community where no one suffers due to a shortage of blood. Blood Link aims to bridge the gap through a reliable network, fostering a culture of voluntary donation.</p>
                </div>
            </section>
        </main>
    </div>
</div>

<div class="modal-backdrop" id="donorContactInfoModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 class="modal-title" id="contactModalTitle">Donor Contact Information</h3>
            <button class="modal-close" data-dismiss="donorContactInfoModal">&times;</button>
        </div>
        <div class="modal-body" id="contactModalBody"></div>
        <p class="modal-reminder">Please use this information responsibly. Blood Link is a directory service.</p>
    </div>
</div>

<div class="modal-backdrop" id="requestOffersModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 class="modal-title" id="offersModalTitle">Offers Received</h3>
            <button class="modal-close" data-dismiss="requestOffersModal">&times;</button>
        </div>
        <div class="modal-body" id="offersModalBody"></div>
    </div>
</div>

<div class="global-message-toast-container" id="globalToastContainer"></div>
<div class="global-loader-overlay" id="globalLoader"><div class="loader-spinner"></div></div>

<audio id="notificationSound" src="https://www.soundjay.com/buttons/beep-01a.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script>
    // --- Firebase Config (Use your actual config) ---
    const firebaseConfig = {
        apiKey: "AIzaSyCWjeZwrqCwe5NWN-Pdm5GPkp1_qJrCuSU",
        authDomain: "bloodlink-278a4.firebaseapp.com",
        databaseURL: "https://bloodlink-278a4-default-rtdb.firebaseio.com",
        projectId: "bloodlink-278a4",
        storageBucket: "bloodlink-278a4.firebasestorage.app",
        messagingSenderId: "88657445618",
        appId: "1:88657445618:web:90999baf48e9718ff5466b",
        measurementId: "G-XQGB69C3TP"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Global State & Elements ---
    let allDonors = [];
    let allRequests = [];
    let lastEmergencyCount = 0;
    const activeSection = { current: 'findDonorSection' }; // Default

    const ui = {
        sidebar: document.getElementById('appSidebar'),
        menuToggleBtn: document.getElementById('menuToggleBtn'),
        themeToggle: document.getElementById('themeToggleSwitch'),
        globalLoader: document.getElementById('globalLoader'),
        toastContainer: document.getElementById('globalToastContainer'),
        notificationSound: document.getElementById('notificationSound'),

        navLinks: document.querySelectorAll('.app-sidebar nav a'),
        sections: {
            findDonorSection: document.getElementById('findDonorSection'),
            registerDonorSection: document.getElementById('registerDonorSection'),
            postEmergencyRequestSection: document.getElementById('postEmergencyRequestSection'),
            viewEmergencyRequestsSection: document.getElementById('viewEmergencyRequestsSection'),
            aboutSection: document.getElementById('aboutSection'),
        },
        // Find Donors
        donorSearchInput: document.getElementById('donorSearchInput'),
        donorsTableContainer: document.getElementById('donorsTableContainer'),
        donorsTableBody: document.getElementById('donorsDisplayTableBody'),
        donorsFallback: document.getElementById('donorsFallbackMessage'),
        actionToAddDonorBtn: document.getElementById('actionToAddDonor'),
        // Register Donor
        donorRegForm: document.getElementById('donorRegistrationForm'),
        // Post Emergency
        emergencyPostForm: document.getElementById('emergencyPostForm'),
        // View Emergencies
        emergencyGrid: document.getElementById('emergencyRequestsGrid'),
        emergencyFallback: document.getElementById('emergencyFallbackMessage'),
        // Modals
        contactModal: document.getElementById('donorContactInfoModal'),
        contactModalTitle: document.getElementById('contactModalTitle'),
        contactModalBody: document.getElementById('contactModalBody'),
        offersModal: document.getElementById('requestOffersModal'),
        offersModalTitle: document.getElementById('offersModalTitle'),
        offersModalBody: document.getElementById('offersModalBody'),
    };

    // --- Utility Functions ---
    const showLoader = () => { if(ui.globalLoader) ui.globalLoader.style.display = 'flex'; };
    const hideLoader = () => { if(ui.globalLoader) ui.globalLoader.style.display = 'none'; };

    function showToast(message, type = 'success') { // types: success, error, warning
        if (!ui.toastContainer) return;
        const toast = document.createElement('div');
        toast.className = `toast-message ${type}`;
        toast.textContent = message;
        ui.toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('active');
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('active');
    }
    document.querySelectorAll('[data-dismiss]').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.dataset.dismiss));
    });
    document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
        backdrop.addEventListener('click', (e) => { if(e.target === backdrop) closeModal(backdrop.id); });
    });

    // --- Theme Manager ---
    function applyTheme(isDark) {
        document.body.classList.toggle('dark', isDark);
        localStorage.setItem('bloodLinkTheme', isDark ? 'dark' : 'light');
        if (ui.themeToggle) ui.themeToggle.checked = isDark;

        // Set RGB for global loader overlay background based on theme
        const rootStyle = getComputedStyle(document.documentElement);
        if (isDark) {
            document.documentElement.style.setProperty('--app-bg-main-dark-rgb', '0,0,0');
        } else {
            document.documentElement.style.setProperty('--app-bg-main-rgb', '242,242,247');
        }
    }
    ui.themeToggle.addEventListener('change', (e) => applyTheme(e.target.checked));
    

    // --- Navigation ---
    function navigateToSection(sectionId) {
        if (!ui.sections[sectionId]) { console.warn(`Section ${sectionId} not found.`); return; }
        Object.values(ui.sections).forEach(s => s.classList.remove('active'));
        ui.sections[sectionId].classList.add('active');
        activeSection.current = sectionId;

        ui.navLinks.forEach(link => {
            link.classList.remove('active-link');
            if (link.id === `nav-${sectionId.replace('Section', '').toLowerCase().replace('postemergencyrequest', 'post-request').replace('viewemergencyrequests', 'view-requests')}`) {
                link.classList.add('active-link');
            }
        });
        if (ui.sidebar.classList.contains('open')) ui.sidebar.classList.remove('open'); // Close sidebar on nav
        window.scrollTo(0,0);
    }

    ui.navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = e.currentTarget.id.substring(4); // remove "nav-"
            const sectionKey = Object.keys(ui.sections).find(key => 
                key.toLowerCase().replace('section', '') === targetId ||
                (targetId === 'post-request' && key === 'postEmergencyRequestSection') ||
                (targetId === 'view-requests' && key === 'viewEmergencyRequestsSection')
            );
            if (sectionKey) navigateToSection(sectionKey);
        });
    });
    if (ui.actionToAddDonorBtn) ui.actionToAddDonorBtn.addEventListener('click', () => navigateToSection('registerDonorSection'));
    ui.menuToggleBtn.addEventListener('click', () => ui.sidebar.classList.toggle('open'));


    // --- Donor Functions ---
    function renderDonorsList() {
        if (!ui.donorsTableBody || !ui.donorsFallback || !ui.donorsTableContainer) return;
        showLoader();
        const searchTerm = ui.donorSearchInput.value.trim().toLowerCase();
        const filteredDonors = allDonors.filter(d =>
            (d.name.toLowerCase().includes(searchTerm) ||
            d.bloodGroup.toLowerCase().includes(searchTerm) ||
            d.city.toLowerCase().includes(searchTerm) ||
            (d.id && d.id.toLowerCase().includes(searchTerm)))
        ).sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

        ui.donorsTableBody.innerHTML = '';
        if (filteredDonors.length === 0) {
            ui.donorsFallback.textContent = searchTerm ? 'No donors match your search.' : 'No donors registered yet.';
            ui.donorsFallback.style.display = 'block';
            ui.donorsTableContainer.style.display = 'none';
        } else {
            ui.donorsFallback.style.display = 'none';
            ui.donorsTableContainer.style.display = 'block';
            filteredDonors.forEach(donor => {
                const row = ui.donorsTableBody.insertRow();
                row.innerHTML = `
                    <td>${donor.name}<span class="donor-id-small">ID: ${donor.id ? donor.id.slice(-6) : 'N/A'}</span></td>
                    <td><span class="status-dot ${donor.availability ? 'status-available' : 'status-unavailable'}"></span>${donor.availability ? 'Available' : 'Unavailable'}</td>
                    <td>${donor.bloodGroup}</td>
                    <td>${donor.city}, ${donor.state}</td>
                    <td>${donor.createdAt ? new Date(donor.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td><button class="btn btn-secondary btn-sm" data-donor-id="${donor.id}">View</button></td>
                `;
                row.querySelector('button').addEventListener('click', () => showDonorContact(donor));
            });
        }
        hideLoader();
    }

    function showDonorContact(donor) {
        ui.contactModalTitle.textContent = `Contact: ${donor.name}`;
        ui.contactModalBody.innerHTML = `
            <p><strong>Phone:</strong> ${donor.phone}</p>
            <p><strong>Email:</strong> ${donor.email || 'Not Provided'}</p>
            <p><strong>Blood Group:</strong> ${donor.bloodGroup}</p>
            <p><strong>Location:</strong> ${donor.city}, ${donor.state}</p>
        `;
        openModal('donorContactInfoModal');
    }

    ui.donorSearchInput.addEventListener('input', renderDonorsList);

    ui.donorRegForm.addEventListener('submit', (e) => {
        e.preventDefault(); showLoader();
        const donorData = {
            name: ui.donorRegForm.querySelector('#regName').value.trim(),
            bloodGroup: ui.donorRegForm.querySelector('#regBloodGroup').value,
            phone: ui.donorRegForm.querySelector('#regPhone').value.trim(),
            email: ui.donorRegForm.querySelector('#regEmail').value.trim().toLowerCase() || null,
            city: ui.donorRegForm.querySelector('#regCity').value.trim(),
            state: ui.donorRegForm.querySelector('#regState').value.trim(),
            availability: ui.donorRegForm.querySelector('#regAvailability').value === 'true',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        if (!donorData.name || !donorData.bloodGroup || !donorData.phone || !donorData.city || !donorData.state) {
            showToast("Please fill all required (*) fields.", "error"); hideLoader(); return;
        }
        db.ref('donors').push(donorData)
            .then(() => { showToast('Donor registered successfully!', 'success'); ui.donorRegForm.reset(); navigateToSection('findDonorSection');})
            .catch(err => { showToast(`Registration failed: ${err.message}`, 'error'); })
            .finally(hideLoader);
    });

    function fetchDonors() {
        showLoader();
        db.ref('donors').on('value', snapshot => {
            allDonors = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => allDonors.push({ id: child.key, ...child.val() }));
            }
            if (activeSection.current === 'findDonorSection' || activeSection.current === 'viewEmergencyRequestsSection') { // Refresh if relevant section is active
                renderDonorsList(); // if findDonor is active
                renderEmergencyRequests(); // if viewRequests is active (for matching donors)
            }
            hideLoader();
        }, err => {
            showToast(`Error fetching donors: ${err.message}`, 'error'); hideLoader();
            if (activeSection.current === 'findDonorSection') renderDonorsList(); // Show empty/error state
        });
    }


    // --- Emergency Request Functions ---
    ui.emergencyPostForm.addEventListener('submit', (e) => {
        e.preventDefault(); showLoader();
        const reqData = {
            requesterName: ui.emergencyPostForm.querySelector('#emReqName').value.trim(),
            requesterContact: ui.emergencyPostForm.querySelector('#emReqContact').value.trim(),
            requesterEmail: ui.emergencyPostForm.querySelector('#emReqEmail').value.trim().toLowerCase() || null,
            requiredBloodGroup: ui.emergencyPostForm.querySelector('#emReqBloodGroup').value,
            city: ui.emergencyPostForm.querySelector('#emReqCity').value.trim(),
            hospitalName: ui.emergencyPostForm.querySelector('#emReqHospital').value.trim(),
            message: ui.emergencyPostForm.querySelector('#emReqMessage').value.trim(),
            status: 'active',
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        if (!reqData.requesterName || !reqData.requesterContact || !reqData.requiredBloodGroup || !reqData.city || !reqData.hospitalName) {
            showToast("Please fill all required (*) fields for emergency.", "error"); hideLoader(); return;
        }
        db.ref('emergencyRequests').push(reqData)
            .then(() => { showToast('Emergency request posted!', 'success'); ui.emergencyPostForm.reset(); navigateToSection('viewEmergencyRequestsSection');})
            .catch(err => { showToast(`Request failed: ${err.message}`, 'error');})
            .finally(hideLoader);
    });

    function renderEmergencyRequests() {
        if (!ui.emergencyGrid || !ui.emergencyFallback) return;
        ui.emergencyGrid.innerHTML = '';
        
        const activeRequests = allRequests.filter(r => r.status === 'active')
                                   .sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

        if (activeRequests.length === 0) {
            ui.emergencyFallback.style.display = 'block';
        } else {
            ui.emergencyFallback.style.display = 'none';
            activeRequests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'emergency-card';
                if (Date.now() - (req.createdAt || 0) < 5 * 60 * 1000) card.classList.add('new-urgent-pulse');
                const offersCount = req.offers ? Object.keys(req.offers).length : 0;
                
                card.innerHTML = `
                    <h3>${req.requiredBloodGroup} Needed in ${req.city}</h3>
                    <p><strong>Requester:</strong> ${req.requesterName}</p>
                    <p><strong>Contact:</strong> ${req.requesterContact}</p>
                    <p><strong>Hospital:</strong> ${req.hospitalName}</p>
                    ${req.message ? `<p><strong>Note:</strong> ${req.message}</p>` : ''}
                    <p class="timestamp">Posted: ${new Date(req.createdAt || Date.now()).toLocaleString()}</p>
                    <div class="actions">
                        <button class="btn btn-primary btn-sm" data-req-id="${req.id}">Offer Help</button>
                        ${offersCount > 0 ? `<button class="btn btn-secondary btn-sm" data-offers-req-id="${req.id}">View Offers (${offersCount})</button>` : ''}
                    </div>
                `;
                card.querySelector('[data-req-id]').addEventListener('click', () => handleOfferHelp(req.id));
                if (offersCount > 0) {
                    card.querySelector('[data-offers-req-id]').addEventListener('click', () => viewRequestOffers(req));
                }
                ui.emergencyGrid.appendChild(card);
            });
        }
    }
    
    function handleOfferHelp(requestId) {
        const name = prompt("Your Name:");
        if (!name) return;
        const contact = prompt("Your Contact Phone:");
        if (!contact) return;

        showLoader();
        db.ref(`emergencyRequests/${requestId}/offers`).push({ offererName: name, offererContact: contact, createdAt: firebase.database.ServerValue.TIMESTAMP })
            .then(() => showToast("Offer submitted. Thank you!", "success"))
            .catch(err => showToast(`Offer submission failed: ${err.message}`, "error"))
            .finally(hideLoader);
    }

    function viewRequestOffers(request) {
        ui.offersModalTitle.textContent = `Offers for ${request.requiredBloodGroup} in ${request.city}`;
        if (request.offers) {
            ui.offersModalBody.innerHTML = Object.values(request.offers).map(offer => `
                <div class="offer-item">
                    <p><strong>Offerer:</strong> ${offer.offererName}</p>
                    <p><strong>Contact:</strong> ${offer.offererContact}</p>
                    <p><small>Offered: ${new Date(offer.createdAt).toLocaleString()}</small></p>
                </div>
            `).join('');
        } else {
            ui.offersModalBody.innerHTML = '<p>No offers yet for this request.</p>';
        }
        openModal('requestOffersModal');
    }


    function fetchEmergencyRequests() {
        showLoader();
        db.ref('emergencyRequests').on('value', snapshot => {
            allRequests = [];
            if (snapshot.exists()) {
                snapshot.forEach(child => allRequests.push({ id: child.key, ...child.val() }));
            }
            if (allRequests.length > lastEmergencyCount && lastEmergencyCount !== 0 && !ui.notificationSound.muted) {
                 ui.notificationSound.play().catch(e=>console.warn("Audio play blocked."));
                 showToast("New emergency request posted!", "warning");
            }
            lastEmergencyCount = allRequests.length;

            if (activeSection.current === 'viewEmergencyRequestsSection') {
                 renderEmergencyRequests();
            }
            hideLoader();
        }, err => {
            showToast(`Error fetching requests: ${err.message}`, 'error'); hideLoader();
            if (activeSection.current === 'viewEmergencyRequestsSection') renderEmergencyRequests();
        });
    }
    
    // --- Admin Link ---
    const adminNavLink = document.getElementById('nav-admin');
    if(adminNavLink) {
        adminNavLink.addEventListener('click', (e) => {
            e.preventDefault();
            const pass = prompt("Admin Password:");
            if (pass === "admin123") window.location.href = "admin.html"; // Ensure admin.html exists
            else if (pass) alert("Incorrect password.");
        });
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('bloodLinkTheme');
        applyTheme(savedTheme === 'dark');
        
        navigateToSection('findDonorSection'); // Default section
        fetchDonors();
        fetchEmergencyRequests();

        // Enable audio on first user interaction
        document.body.addEventListener('click', function enableAudioPlayback() {
            if (ui.notificationSound && ui.notificationSound.muted !== false) {
                ui.notificationSound.muted = true; // Mute, play, pause, unmute to "unlock"
                const playPromise = ui.notificationSound.play();
                if(playPromise !== undefined) {
                    playPromise.then(() => {
                        ui.notificationSound.pause();
                        ui.notificationSound.currentTime = 0;
                        ui.notificationSound.muted = false;
                        document.body.removeEventListener('click', enableAudioPlayback);
                    }).catch(e => console.warn("Audio unlock play failed."));
                } else { // Fallback for browsers not returning promise
                    ui.notificationSound.pause(); ui.notificationSound.currentTime = 0; ui.notificationSound.muted = false;
                    document.body.removeEventListener('click', enableAudioPlayback);
                }
            } else if (ui.notificationSound && ui.notificationSound.muted === false){
                 document.body.removeEventListener('click', enableAudioPlayback); // Already unmuted
            }
        }, { once: true });
        
        // Initialize RGB vars based on initial theme for loader overlay
        const currentIsDark = document.body.classList.contains('dark');
         if (currentIsDark) {
            document.documentElement.style.setProperty('--app-bg-main-dark-rgb', '0,0,0');
        } else {
            document.documentElement.style.setProperty('--app-bg-main-rgb', '242,242,247');
        }
    });

</script>
</body>
</html>
